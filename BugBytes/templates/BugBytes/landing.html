{% extends "base.html" %} {% load static %} {% block content %}
<div class="header">
    <h1>BugBytes</h1>
</div>

<div class="container">
    <div class="upload">
        <div class="dropzone" id="myDropzone"></div>
        <div class="row">
            <div class="input_box">
                <label for="">
                <!-- <input type="file" id="myFile" size="50" onchange="uploadImage(event)"> -->
                </label>
            </div>
        </div>
    </div>
    <div class="identify">
        <button class="identify">Identify!</button>
    </div>

</div>


<!-- <script src="https://unpkg.com/dropzone"></script> -->
<script src="{% static 'dropzone.js' %}"></script>
<script src="https://unpkg.com/cropperjs"></script>

<script>
    Dropzone.options.myDropzone = {
        url: '/post',
        transformFile: function(file, done) {

            // Create Dropzone reference for use in confirm button click handler
            var myDropZone = this;

            // Create the image editor overlay
            var editor = document.createElement('div');
            editor.setAttribute('id', 'insectPic')
            editor.style.position = 'fixed';
            editor.style.left = 0;
            editor.style.right = 0;
            editor.style.top = 0;
            editor.style.bottom = 0;
            editor.style.zIndex = 9999;
            editor.style.backgroundColor = '#000';
            document.body.appendChild(editor);

            // Create confirm button at the top left of the viewport
            var buttonConfirm = document.createElement('button');
            buttonConfirm.style.position = 'absolute';
            buttonConfirm.style.left = '10px';
            buttonConfirm.style.top = '10px';
            buttonConfirm.style.zIndex = 9999;
            buttonConfirm.textContent = 'Confirm';
            editor.appendChild(buttonConfirm);
            buttonConfirm.addEventListener('click', function() {
                // Get the canvas with image data from Cropper.js
                var canvas = cropper.getCroppedCanvas({
                    width: 256,
                    height: 256
                });
                // Turn the canvas into a Blob (file object without a name)
                canvas.toBlob(function(blob) {

                    // Create a new Dropzone file thumbnail
                    myDropZone.createThumbnail(
                        blob,
                        myDropZone.options.thumbnailWidth,
                        myDropZone.options.thumbnailHeight,
                        myDropZone.options.thumbnailMethod,
                        false,
                        function(dataURL) {

                            // Update the Dropzone file thumbnail
                            myDropZone.emit('thumbnail', file, dataURL);
                            // Return the file to Dropzone
                            done(blob);

                            var images = [];
                            myDropZone.getQueuedFiles().forEach(function(file) {
                                let image = {
                                    dataURL: file.dataURL,
                                    name: file.name,
                                    type: file.type,
                                    size: file.size,
                                };
                                images.push(image);
                            });
                            sessionStorage.setItem("images", JSON.stringify(images));

                            var images = JSON.parse(sessionStorage.getItem('images'));
                            images.forEach(function(image) {
                                dropzone.files.push(image);
                                dropzone.emit("addedfile", image);
                                dropzone.emit("thumbnail", image, image.dataURL);
                                dropzone.emit("complete", image);
                            });
                            myDropZone.options.maxFiles = myDropZone.options.maxFiles - images.length;
                            console.log(sessionStorage)
                        });
                    done(blob);
                });

                // Remove the editor from the view
                document.body.removeChild(editor);
            });

            // Create an image node for Cropper.js
            var image = new Image();
            image.src = URL.createObjectURL(file);
            editor.appendChild(image);

            // Create Cropper.js
            var cropper = new Cropper(image, {
                aspectRatio: 1
            });
        }
    };
</script>

{% endblock %}